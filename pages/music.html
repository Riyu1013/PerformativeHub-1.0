<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <!-- Bootstrap JS -->
    <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>

    <!-- Bootstrap ICONS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">

    <link rel="stylesheet" href="../styles.css">
    <title>Music Page</title>
</head>
<body>

<nav class="navbar navbar-expand-lg bg-body" id="my-nav">
  <div class="container-fluid">
    <div class="brand-wrapper">
      <a class="navbar-brand" id="hero-text.shrink" href="../pages/index.html">Performative <br> Website</a>
    </div>
    <div class="nav-item">
      <a class="justify-content-end fs-5" href="about.html">About, </a>
      <a class="justify-content-end fs-5" href="contact.html">Contact, </a>
      <a class="justify-content-end fs-5" href="">Cart</a>
    </div>
  </div>
</nav>

<div class="container-fluid row min-vh-100 mt-5">
  <div class="col-lg-8" id="song-list">
    <table class="table table-hover">
      <h2>Songs</h2>
      <thead>
        <tr>
          <th>Title</th>
          <th>Artist</th>
        </tr>
      </thead>
      <tbody class="table-group-divider" id="tbody-songs"></tbody>
    </table>
  </div>

  <div class="col-lg-4">
    <div class="d-flex flex-column">
      <div class="d-flex justify-content-center align-items-center pe-none" id="vinyl-container">
        <img src="../media/songs/black-vinyl-record-with-red-label-illustration-png.png" alt="Vinyl Record" id="vinyl-record">
      </div>
      <div class="d-flex flex-column justify-content-center">
        <input class="mx-auto mt-3" type="range" min="0" max="0.5" step="0.01" id="volume-slider">
        <p class="fst-italic text-center mb-0">Volume</p>
      </div>
      <div class="d-flex flex-column align-items-center" id="audio-control">
        <div class="d-flex column-gap-3 my-3">
          <button class="btn btn-secondary" id="play-button"><i class="bi bi-play-fill"></i></button>
          <button class="btn btn-secondary" id="pause-button"><i class="bi bi-pause-fill"></i></button>
        </div>
        <!-- Purchase Control -->
        <div class="w-50 text-center my-3" id="book-purchase-control">
          <h4 class="mb-0" id="title">Title</h4>
          <p class="mb-0" id="artist">By Artist</p>
          <hr class="mx-auto my-2">
          <div class="d-flex align-items-center justify-content-evenly mb-3" id="purchase-popup-quantity-group">
            <div class="">Quantity</div>
            <p class="text-center fs-3 mb-0" id="purchase-quantity">1</p>
            <div class="d-grid gap-2 d-md-block">
              <button class="btn btn-secondary" type="button" id="decrease-button"> - </button>
              <button class="btn btn-secondary" type="button" id="increase-button"> + </button>
            </div>
          </div>
          <div class="d-flex justify-content-center">
            <button class="btn btn-primary" type="button" id="add-to-cart-btn">Add To Cart</button>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<audio id="audio-player"></audio>

<footer id="footer">
  <div class="footer-brand">
    <h1>DON'T MISS NEW ITEMS</h1>
    <form class="w-100 m-0">
    <div class="row g-3">
      <div class="col-md-10">
      <input type="email" class="form-control" id="exampleInputEmail1" aria-describedby="emailHelp" placeholder="Enter your email">
      </div>
      <div class="col-md-2">
      <button type="submit" class="btn btn-primary">Go</button>
      </div>
    </div>
    </form>
  </div>
  <div class="footer-nav">
    <div class="footer-info">
    <h4>You Can Find Us</h4>
    <p>performative@gmail.com</p>
    <p>+12 345 6789</p>
    <p>Governor Pack Road, Baguio City, 2600, Benguet, Philippines</p>
    </div>
    <div class="footer-faq">
    <h4>We Will Always Help</h4>
    <p>Terms and Conditions</p>
    <p>Privacy Policy</p>
    <p>Cookies</p>
    <p>Shipping & Returns</p>
    </div>
  </div>
</footer>

<div class="cursor" id="cursor">
  <svg width="60" height="60">
    <circle cx="30" cy="30" r="20" stroke="black" stroke-width="1" fill="white"></circle>
  </svg>
</div>

<!-- Global JS -->
<script defer src="../script/main.js"></script>
<!-- MUSIC -->
<script src="../script/data-music.js"></script>
<script>
  const tbody = document.getElementById("tbody-songs");

  // Populate the music table
  for (let i = 0; i < SONGS.length; i++) {
    const song = SONGS[i];

    const row = document.createElement("tr");

    const title = document.createElement("td");
    title.textContent = song.title;

    const artist = document.createElement("td");
    artist.textContent = song.artist;

    row.dataset.title = song.title;
    row.dataset.artist = song.artist;
    row.dataset.coverSrc = "../media/songs/covers/" + song.coverFilename;
    row.dataset.audioSrc = "../media/songs/audio/" + song.audioFilename;
    row.dataset.id = "song-" + i;
    row.appendChild(title);
    row.appendChild(artist);

    tbody.appendChild(row);
  }

  const vinylContainer = document.getElementById('vinyl-container');
  const audioPlayer = document.getElementById('audio-player');

  // IMPORTANT!
  const MAX_AUDIO_VOLUME = 0.5;
  audioPlayer.volume = MAX_AUDIO_VOLUME / 2;

  // Attach volume controls
  document.getElementById("volume-slider").addEventListener("input", (e) => {
    audioPlayer.volume = e.currentTarget.value;
  });

  document.getElementById("play-button").addEventListener("click", () => {
    if (!audioPlayer.src) return;
    audioPlayer.play();
    vinylContainer.classList.add("is-playing");
  });

  document.getElementById("pause-button").addEventListener("click", () => {
    if (!audioPlayer.src) return;
    audioPlayer.pause();
    vinylContainer.classList.remove("is-playing");
  });

  const cover = document.createElement("img");
  cover.id = "album-cover-img";
  cover.classList.add("album-cover", "position-absolute");
  vinylContainer.appendChild(cover);

  let activeRow = null;

  function updateVinylPlayer(e) {
    const clickedRow = e.target.closest('tr');
    if (!clickedRow) return;

    // Change active row
    if (activeRow)
      activeRow.classList.remove("table-active");

    activeRow = clickedRow;
    activeRow.classList.add("table-active");
    
    // Update the vinyl (and the player)
    cover.src = activeRow.dataset.coverSrc;
    audioPlayer.src = activeRow.dataset.audioSrc;

    // Update purchase control
    document.getElementById("title").innerHTML = activeRow.dataset.title;
    document.getElementById("artist").innerHTML = activeRow.dataset.artist;

    // Stop current playback and reset state
    audioPlayer.pause();
    audioPlayer.currentTime = 0;

    setTimeout(playSong, 1000);
  }

  function playSong() {
    // This starts the CSS animation and fades in the cover
    vinylContainer.classList.add('is-playing');
      
    audioPlayer.play()
      .then(() => {
          console.log(`Now playing: ${activeRow.firstElementChild.textContent}`);
      })
      .catch(error => {
          console.error("Audio playback failed.", error);
    });
  }
  
  tbody.addEventListener("click", updateVinylPlayer);

  // ========== Purchase Control ========== //
  const MIN_PURCHASE_AMOUNT = 1;
  const MAX_PURCHASE_AMOUNT = 10;
  const PURCHASE_AMOUNT_ID = "purchase-quantity";


  function getPurchaseAmount() {
      return document.getElementById(PURCHASE_AMOUNT_ID).innerHTML;
  }

  function setPurchaseAmount(value) {
      document.getElementById(PURCHASE_AMOUNT_ID).innerHTML = value;
  }

  function updatePurchaseAmountBy(value) {
      let purchaseAmount = parseInt(getPurchaseAmount());
      purchaseAmount += value;
      // Clamp the purchase amount
      purchaseAmount = Math.min(Math.max(purchaseAmount, MIN_PURCHASE_AMOUNT), MAX_PURCHASE_AMOUNT);
      setPurchaseAmount(purchaseAmount);
  }

  function onClickHandler(value) {
      updatePurchaseAmountBy(value);
  }

  document.getElementById("decrease-button").addEventListener("click", (e) => {onClickHandler(-1)});
  document.getElementById("increase-button").addEventListener("click", (e) => {onClickHandler(1)});

  // Add to cart functionality
  const cart = JSON.parse(sessionStorage.getItem("cart")) || [];
  document.getElementById("add-to-cart-btn").addEventListener("click", () => {
    // Get current product info from popup
    const product = {
      title: document.getElementById("title").textContent,
      image: cover.src,
      quantity: parseInt(getPurchaseAmount())
    };

    // Check if already in cart by title (or id)
    const existingIndex = cart.findIndex(item => item.title === product.title);
    if (existingIndex >= 0) {
      cart[existingIndex].quantity += product.quantity;
    } else {
      cart.push(product);
    }

    // Save back to sessionStorage
    sessionStorage.setItem("cart", JSON.stringify(cart));
    alert(`${product.title} added to cart!`);
  });

</script>
</body>
</html>